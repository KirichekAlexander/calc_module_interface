name: build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  windows:
    runs-on: windows-2022
    env:
      APP_NAME: calc_module_interface
      QT_VERSION: 5.15.2
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt (Qt5)
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          cache: true
          modules: qtcharts

      - name: Configure
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Package (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist | Out-Null

          if (Test-Path "build\${env:APP_NAME}.exe") {
            Copy-Item "build\${env:APP_NAME}.exe" "dist\" -Force
          } elseif (Test-Path "build\Release\${env:APP_NAME}.exe") {
            Copy-Item "build\Release\${env:APP_NAME}.exe" "dist\" -Force
          } else {
            Get-ChildItem -Recurse build | Select-Object FullName
            throw "EXE not found"
          }

          # QT_ROOT_DIR выставляет install-qt-action :contentReference[oaicite:3]{index=3}
          & "$env:QT_ROOT_DIR\bin\windeployqt.exe" "dist\${env:APP_NAME}.exe"
          Compress-Archive -Path dist\* -DestinationPath "${env:APP_NAME}-windows.zip" -Force

      - uses: actions/upload-artifact@v4
        with:
          name: windows
          path: "*.zip"

  astra:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Build Astra (Docker) + tar.gz
        run: |
          docker build -t astra-qt5 -f ci/astra/Dockerfile .
          chmod +x ci/astra/build.sh
          mkdir -p out
          docker run --rm -v "$PWD:/src" -v "$PWD/out:/out" -w /src astra-qt5 bash -lc "./ci/astra/build.sh"
          ls -la out

      - uses: actions/upload-artifact@v4
        with:
          name: astra-tar
          path: out/*.tar.gz
